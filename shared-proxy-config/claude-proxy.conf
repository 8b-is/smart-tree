# Claude API proxy configuration
# This proxies requests to Claude API with authentication and rate limiting

user nginx;
worker_processes 1;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/json;

    # Environment variable for API key
    env CLAUDE_API_KEY;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=claude_limit:10m rate=20r/m;

    # Upstream Claude API
    upstream claude_api {
        server api.anthropic.com:443;
        keepalive 16;
    }

    server {
        listen 8090;
        server_name localhost;

        # Health check
        location /health {
            access_log off;
            return 200 '{"status":"healthy"}';
            add_header Content-Type application/json;
        }

        # Claude Messages API
        location /v1/messages {
            limit_req zone=claude_limit burst=5 nodelay;

            # Check for API key in request
            if ($http_x_api_key = "") {
                return 401 '{"error":"Missing X-API-Key header"}';
            }

            # Proxy to Claude API
            proxy_pass https://claude_api/v1/messages;
            proxy_ssl_server_name on;
            proxy_http_version 1.1;
            
            # Set headers
            proxy_set_header Host api.anthropic.com;
            proxy_set_header X-API-Key $CLAUDE_API_KEY;
            proxy_set_header Content-Type application/json;
            proxy_set_header anthropic-version "2023-06-01";
            
            # Remove client's API key header
            proxy_hide_header X-API-Key;
            
            # Timeouts for streaming responses
            proxy_connect_timeout 60s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
            proxy_buffering off;
            
            # Enable streaming
            proxy_set_header Connection "";
            proxy_set_header Cache-Control no-cache;
            
            # CORS headers (adjust as needed)
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, X-API-Key" always;
            
            if ($request_method = 'OPTIONS') {
                return 204;
            }
        }

        # Claude Completions API (legacy)
        location /v1/complete {
            limit_req zone=claude_limit burst=5 nodelay;

            if ($http_x_api_key = "") {
                return 401 '{"error":"Missing X-API-Key header"}';
            }

            proxy_pass https://claude_api/v1/complete;
            proxy_ssl_server_name on;
            proxy_http_version 1.1;
            
            proxy_set_header Host api.anthropic.com;
            proxy_set_header X-API-Key $CLAUDE_API_KEY;
            proxy_set_header Content-Type application/json;
            proxy_set_header anthropic-version "2023-06-01";
            
            proxy_hide_header X-API-Key;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
            proxy_buffering off;
        }

        # Error handling
        error_page 500 502 503 504 /50x.json;
        location = /50x.json {
            internal;
            return 500 '{"error":"Internal server error"}';
        }

        error_page 401 /401.json;
        location = /401.json {
            internal;
            return 401 '{"error":"Unauthorized"}';
        }

        error_page 429 /429.json;
        location = /429.json {
            internal;
            return 429 '{"error":"Rate limit exceeded"}';
        }
    }
}