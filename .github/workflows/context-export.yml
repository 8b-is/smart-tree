# ============================================================================
# AI Context Export Workflow - Smart Tree
# ============================================================================
# Generates optimized context snapshots for AI assistants
# Creates release artifacts with pre-computed context for instant loading
# ============================================================================
name: AI Context Export ðŸ§ 

on:
  release:
    types: [published]
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'Cargo.toml'
  workflow_dispatch:
    inputs:
      context_depth:
        description: 'Context depth for export'
        required: false
        default: '5'
        type: string
      compression_mode:
        description: 'Compression mode'
        required: false
        default: 'quantum'
        type: choice
        options:
          - quantum
          - quantum-semantic
          - ai
          - digest

env:
  CARGO_TERM_COLOR: always
  AI_TOOLS: "1"
  SMART_TREE_NO_UPDATE_CHECK: 1

permissions:
  contents: write

jobs:
  export-context:
    name: Export AI Context ðŸ“¤
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code ðŸ“¦
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: 'recursive'

    - name: Install Rust ðŸ¦€
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo ðŸ“š
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-context-${{ hashFiles('**/Cargo.lock') }}

    - name: Build Smart Tree ðŸ”¨
      run: cargo build --release

    - name: Set context parameters ðŸŽ›ï¸
      id: params
      run: |
        DEPTH="${{ github.event.inputs.context_depth || '5' }}"
        MODE="${{ github.event.inputs.compression_mode || 'quantum' }}"
        echo "depth=$DEPTH" >> $GITHUB_OUTPUT
        echo "mode=$MODE" >> $GITHUB_OUTPUT

    - name: Generate context snapshots ðŸ“¸
      run: |
        mkdir -p context-export

        # Generate multiple context formats
        MODES=("quantum" "quantum-semantic" "ai" "json" "digest")

        for mode in "${MODES[@]}"; do
          echo "Generating context: $mode"
          ./target/release/st \
            --mode "$mode" \
            --depth ${{ steps.params.outputs.depth }} \
            . > "context-export/smart-tree-context-${mode}.txt" 2>/dev/null || true

          # Calculate stats
          if [[ -s "context-export/smart-tree-context-${mode}.txt" ]]; then
            SIZE=$(wc -c < "context-export/smart-tree-context-${mode}.txt")
            echo "  Generated: ${SIZE} bytes"
          fi
        done

        # Generate project overview
        ./target/release/st --mode context . > context-export/PROJECT_CONTEXT.md 2>/dev/null || true

        # Generate MCP tool reference
        ./target/release/st --mcp-tools > context-export/MCP_TOOLS.txt 2>/dev/null || true

    - name: Create context metadata ðŸ“‹
      run: |
        # Generate metadata file
        cat > context-export/CONTEXT_METADATA.json << EOF
        {
          "generated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "git_commit": "${{ github.sha }}",
          "git_ref": "${{ github.ref }}",
          "depth": ${{ steps.params.outputs.depth }},
          "formats": {
            "quantum": {
              "file": "smart-tree-context-quantum.txt",
              "description": "Binary delta compressed, highest compression ratio",
              "recommended_for": ["token_limited_contexts", "large_codebases"]
            },
            "quantum-semantic": {
              "file": "smart-tree-context-quantum-semantic.txt",
              "description": "AST-aware compression with semantic tokens",
              "recommended_for": ["code_understanding", "semantic_analysis"]
            },
            "ai": {
              "file": "smart-tree-context-ai.txt",
              "description": "Hex-encoded with SHA256 tree hash",
              "recommended_for": ["general_llm_use", "context_verification"]
            },
            "json": {
              "file": "smart-tree-context-json.txt",
              "description": "Structured JSON output",
              "recommended_for": ["programmatic_access", "api_integration"]
            },
            "digest": {
              "file": "smart-tree-context-digest.txt",
              "description": "SHA256 hash + statistics only",
              "recommended_for": ["quick_verification", "minimal_context"]
            }
          },
          "usage_instructions": "Load the appropriate context file based on your token budget and use case. Quantum mode achieves ~70% compression, quantum-semantic achieves ~65% while preserving AST information."
        }
        EOF

    - name: Create usage guide ðŸ“–
      run: |
        cat > context-export/USAGE_GUIDE.md << 'EOF'
        # Smart Tree Context Export

        ## Quick Start

        Load the appropriate context file for your AI assistant:

        ### For Claude/GPT with limited context
        ```
        smart-tree-context-quantum.txt
        ```
        Highest compression ratio (~70%), ideal for large codebases.

        ### For code understanding tasks
        ```
        smart-tree-context-quantum-semantic.txt
        ```
        Preserves AST information for better code comprehension.

        ### For general use
        ```
        smart-tree-context-ai.txt
        ```
        Good balance of compression and readability.

        ### For verification/hashing
        ```
        smart-tree-context-digest.txt
        ```
        Just the SHA256 hash and basic statistics.

        ## Integration

        ### Claude Desktop
        Add context via the conversation or attach as a file.

        ### Claude Code
        Use Smart Tree as an MCP server for real-time context.

        ### API Usage
        Use the JSON format for programmatic access.

        ---
        Generated by Smart Tree ðŸŒ³
        EOF

    - name: Calculate compression stats ðŸ“Š
      run: |
        echo "=== Context Export Statistics ===" | tee context-export/STATS.txt

        # Classic baseline (for comparison)
        ./target/release/st --mode classic --depth ${{ steps.params.outputs.depth }} . > /tmp/classic.txt 2>/dev/null || true
        CLASSIC_SIZE=$(wc -c < /tmp/classic.txt 2>/dev/null || echo "0")

        echo "" >> context-export/STATS.txt
        echo "| Format | Size | Compression |" >> context-export/STATS.txt
        echo "|--------|------|-------------|" >> context-export/STATS.txt
        echo "| Classic (baseline) | ${CLASSIC_SIZE} bytes | 1.00x |" >> context-export/STATS.txt

        for file in context-export/smart-tree-context-*.txt; do
          if [[ -s "$file" ]]; then
            SIZE=$(wc -c < "$file")
            NAME=$(basename "$file" .txt | sed 's/smart-tree-context-//')

            if [[ $CLASSIC_SIZE -gt 0 ]]; then
              RATIO=$(echo "scale=2; $CLASSIC_SIZE / $SIZE" | bc 2>/dev/null || echo "N/A")
            else
              RATIO="N/A"
            fi

            echo "| $NAME | ${SIZE} bytes | ${RATIO}x |" >> context-export/STATS.txt
          fi
        done

        cat context-export/STATS.txt

    - name: Upload context artifacts ðŸ“¤
      uses: actions/upload-artifact@v4
      with:
        name: ai-context-export
        path: context-export/
        retention-days: 30

    - name: Attach to release (if applicable) ðŸ“Ž
      if: github.event_name == 'release'
      run: |
        # Create a zip of all context files
        cd context-export
        zip -r ../smart-tree-ai-context.zip .
        cd ..

        # Upload to release
        gh release upload "${{ github.event.release.tag_name }}" \
          smart-tree-ai-context.zip \
          --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-summary:
    name: Export Summary ðŸ“Š
    needs: export-context
    runs-on: ubuntu-latest

    steps:
    - name: Download artifacts ðŸ“¥
      uses: actions/download-artifact@v4
      with:
        name: ai-context-export
        path: context-export

    - name: Generate summary ðŸ“
      run: |
        echo "# ðŸ§  AI Context Export Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Context snapshots have been generated for AI integration." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ -f context-export/STATS.txt ]]; then
          echo "## Compression Statistics" >> $GITHUB_STEP_SUMMARY
          cat context-export/STATS.txt >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Available Formats" >> $GITHUB_STEP_SUMMARY
        echo "- **Quantum**: Highest compression for token-limited contexts" >> $GITHUB_STEP_SUMMARY
        echo "- **Quantum-Semantic**: AST-aware compression for code understanding" >> $GITHUB_STEP_SUMMARY
        echo "- **AI**: Balanced format with SHA256 verification" >> $GITHUB_STEP_SUMMARY
        echo "- **JSON**: Structured output for programmatic access" >> $GITHUB_STEP_SUMMARY
        echo "- **Digest**: Minimal footprint verification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download artifacts from this workflow run to use the context files. ðŸŒ³" >> $GITHUB_STEP_SUMMARY
