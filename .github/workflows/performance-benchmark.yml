# ============================================================================
# Performance Benchmark Suite - Smart Tree
# ============================================================================
# Comprehensive performance testing for AI workloads
# Tracks regression and generates performance reports
# ============================================================================
name: Performance Benchmarks ðŸ“ˆ

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'Cargo.toml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'Cargo.toml'
  schedule:
    # Run weekly performance checks
    - cron: '0 6 * * 1'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  AI_TOOLS: "1"
  SMART_TREE_NO_UPDATE_CHECK: 1

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark-scan-speed:
    name: Directory Scan Performance ðŸ”
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code ðŸ“¦
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install Rust ðŸ¦€
      uses: dtolnay/rust-toolchain@stable

    - name: Install hyperfine â±ï¸
      run: |
        wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
        sudo dpkg -i hyperfine_1.18.0_amd64.deb

    - name: Cache cargo ðŸ“š
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

    - name: Build Smart Tree (release) ðŸ”¨
      run: cargo build --release

    - name: Create test directory structure ðŸ“
      run: |
        # Create a realistic test directory
        mkdir -p /tmp/bench_test
        cd /tmp/bench_test

        # Generate 1000 files across 100 directories
        for i in $(seq 1 100); do
          mkdir -p "dir_$i"
          for j in $(seq 1 10); do
            echo "// File content $i-$j" > "dir_$i/file_$j.rs"
          done
        done

        # Add some nested structures
        mkdir -p deep/nested/structure/for/testing
        for i in $(seq 1 50); do
          echo "Content $i" > "deep/nested/structure/for/testing/file_$i.txt"
        done

    - name: Benchmark scan speed âš¡
      id: scan
      run: |
        cd ${{ github.workspace }}

        echo "=== Scan Speed Benchmarks ===" | tee /tmp/bench_results.txt

        # Benchmark different modes
        hyperfine \
          --warmup 3 \
          --min-runs 10 \
          --export-json /tmp/scan_benchmark.json \
          --export-markdown /tmp/scan_benchmark.md \
          './target/release/st --mode classic --depth 5 /tmp/bench_test' \
          './target/release/st --mode ai --depth 5 /tmp/bench_test' \
          './target/release/st --mode quantum --depth 5 /tmp/bench_test' \
          './target/release/st --mode json --depth 5 /tmp/bench_test'

        cat /tmp/scan_benchmark.md >> /tmp/bench_results.txt

        # Extract mean times for comparison
        CLASSIC_TIME=$(jq '.results[0].mean' /tmp/scan_benchmark.json)
        AI_TIME=$(jq '.results[1].mean' /tmp/scan_benchmark.json)

        echo "classic_time=$CLASSIC_TIME" >> $GITHUB_OUTPUT
        echo "ai_time=$AI_TIME" >> $GITHUB_OUTPUT

    - name: Upload benchmark results ðŸ“¤
      uses: actions/upload-artifact@v4
      with:
        name: scan-benchmarks
        path: |
          /tmp/scan_benchmark.json
          /tmp/scan_benchmark.md

  benchmark-compression:
    name: Compression Performance ðŸ—œï¸
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code ðŸ“¦
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install Rust ðŸ¦€
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo ðŸ“š
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-compress-${{ hashFiles('**/Cargo.lock') }}

    - name: Build Smart Tree (release) ðŸ”¨
      run: cargo build --release

    - name: Benchmark compression ratios ðŸ“Š
      run: |
        echo "=== Compression Ratio Benchmarks ===" | tee /tmp/compress_results.txt
        echo "" >> /tmp/compress_results.txt

        # Test on the actual codebase
        echo "| Mode | Output Size | Compression Ratio |" >> /tmp/compress_results.txt
        echo "|------|-------------|-------------------|" >> /tmp/compress_results.txt

        # Classic baseline
        ./target/release/st --mode classic --depth 5 src/ > /tmp/classic.txt 2>/dev/null
        CLASSIC_SIZE=$(wc -c < /tmp/classic.txt)
        echo "| Classic | ${CLASSIC_SIZE} bytes | 1.00x (baseline) |" >> /tmp/compress_results.txt

        # AI mode
        ./target/release/st --mode ai --depth 5 src/ > /tmp/ai.txt 2>/dev/null
        AI_SIZE=$(wc -c < /tmp/ai.txt)
        AI_RATIO=$(echo "scale=2; $CLASSIC_SIZE / $AI_SIZE" | bc)
        echo "| AI | ${AI_SIZE} bytes | ${AI_RATIO}x |" >> /tmp/compress_results.txt

        # Quantum mode
        ./target/release/st --mode quantum --depth 5 src/ > /tmp/quantum.txt 2>/dev/null
        QUANTUM_SIZE=$(wc -c < /tmp/quantum.txt)
        QUANTUM_RATIO=$(echo "scale=2; $CLASSIC_SIZE / $QUANTUM_SIZE" | bc)
        echo "| Quantum | ${QUANTUM_SIZE} bytes | ${QUANTUM_RATIO}x |" >> /tmp/compress_results.txt

        # Quantum-semantic mode
        ./target/release/st --mode quantum-semantic --depth 5 src/ > /tmp/qsem.txt 2>/dev/null
        QSEM_SIZE=$(wc -c < /tmp/qsem.txt)
        QSEM_RATIO=$(echo "scale=2; $CLASSIC_SIZE / $QSEM_SIZE" | bc)
        echo "| Quantum-Semantic | ${QSEM_SIZE} bytes | ${QSEM_RATIO}x |" >> /tmp/compress_results.txt

        # Digest mode
        ./target/release/st --mode digest --depth 5 src/ > /tmp/digest.txt 2>/dev/null
        DIGEST_SIZE=$(wc -c < /tmp/digest.txt)
        DIGEST_RATIO=$(echo "scale=2; $CLASSIC_SIZE / $DIGEST_SIZE" | bc)
        echo "| Digest | ${DIGEST_SIZE} bytes | ${DIGEST_RATIO}x |" >> /tmp/compress_results.txt

        cat /tmp/compress_results.txt

        # Save for summary
        echo "QUANTUM_RATIO=$QUANTUM_RATIO" >> $GITHUB_ENV

    - name: Upload compression results ðŸ“¤
      uses: actions/upload-artifact@v4
      with:
        name: compression-benchmarks
        path: /tmp/compress_results.txt

  benchmark-memory:
    name: Memory Usage Analysis ðŸ§ 
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code ðŸ“¦
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install Rust ðŸ¦€
      uses: dtolnay/rust-toolchain@stable

    - name: Install memory profiler ðŸ“
      run: |
        sudo apt-get update
        sudo apt-get install -y time

    - name: Cache cargo ðŸ“š
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-memory-${{ hashFiles('**/Cargo.lock') }}

    - name: Build Smart Tree (release) ðŸ”¨
      run: cargo build --release

    - name: Measure memory usage ðŸ“Š
      run: |
        echo "=== Memory Usage Benchmarks ===" | tee /tmp/memory_results.txt

        # Use /usr/bin/time for memory measurement
        echo "" >> /tmp/memory_results.txt
        echo "### Small Directory (src/)" >> /tmp/memory_results.txt
        /usr/bin/time -v ./target/release/st --mode quantum --depth 5 src/ > /dev/null 2>&1 || \
        /usr/bin/time -f "Max RSS: %M KB\nUser time: %U s\nSystem time: %S s" \
          ./target/release/st --mode quantum --depth 5 src/ > /dev/null 2>> /tmp/memory_results.txt

        echo "" >> /tmp/memory_results.txt
        echo "### Medium Directory (entire repo)" >> /tmp/memory_results.txt
        /usr/bin/time -f "Max RSS: %M KB\nUser time: %U s\nSystem time: %S s" \
          ./target/release/st --mode quantum --depth 10 . > /dev/null 2>> /tmp/memory_results.txt

        cat /tmp/memory_results.txt

    - name: Upload memory results ðŸ“¤
      uses: actions/upload-artifact@v4
      with:
        name: memory-benchmarks
        path: /tmp/memory_results.txt

  generate-report:
    name: Generate Performance Report ðŸ“Š
    needs: [benchmark-scan-speed, benchmark-compression, benchmark-memory]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Download all artifacts ðŸ“¥
      uses: actions/download-artifact@v4
      with:
        path: benchmarks

    - name: Generate summary report ðŸ“
      run: |
        echo "# ðŸ“ˆ Smart Tree Performance Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Performance benchmarks for commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "## ðŸ” Scan Speed" >> $GITHUB_STEP_SUMMARY
        if [[ -f benchmarks/scan-benchmarks/scan_benchmark.md ]]; then
          cat benchmarks/scan-benchmarks/scan_benchmark.md >> $GITHUB_STEP_SUMMARY
        else
          echo "Benchmark data not available" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ—œï¸ Compression Ratios" >> $GITHUB_STEP_SUMMARY
        if [[ -f benchmarks/compression-benchmarks/compress_results.txt ]]; then
          cat benchmarks/compression-benchmarks/compress_results.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "Compression data not available" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ§  Memory Usage" >> $GITHUB_STEP_SUMMARY
        if [[ -f benchmarks/memory-benchmarks/memory_results.txt ]]; then
          cat benchmarks/memory-benchmarks/memory_results.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "Memory data not available" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¸ Smart Tree: Because life's too short for slow directory traversal!" >> $GITHUB_STEP_SUMMARY

    - name: Comment on PR (if applicable) ðŸ’¬
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          let comment = '## ðŸ“ˆ Performance Benchmark Results\n\n';
          comment += 'Benchmarks completed for this PR.\n\n';

          // Read compression results if available
          try {
            const compress = fs.readFileSync('benchmarks/compression-benchmarks/compress_results.txt', 'utf8');
            comment += '### Compression Ratios\n';
            comment += compress + '\n';
          } catch (e) {
            comment += 'Compression benchmarks not available.\n';
          }

          comment += '\n[View full report in workflow summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
