# ============================================================================
# Auto Documentation Generator - Smart Tree
# ============================================================================
# Automatically generates and updates documentation from code
# Keeps README, CLI reference, and MCP tool docs in sync
# ============================================================================
name: Auto Documentation ðŸ“š

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/cli.rs'
      - 'src/mcp/**'
      - 'src/lib.rs'
      - 'Cargo.toml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-cli-docs:
    name: Generate CLI Reference ðŸ“–
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code ðŸ“¦
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Rust ðŸ¦€
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo ðŸ“š
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}

    - name: Build Smart Tree ðŸ”¨
      run: cargo build --release

    - name: Generate CLI help documentation ðŸ“
      run: |
        mkdir -p docs

        # Generate main help
        echo "# Smart Tree CLI Reference" > docs/CLI_REFERENCE.md
        echo "" >> docs/CLI_REFERENCE.md
        echo "Auto-generated from \`st --help\`" >> docs/CLI_REFERENCE.md
        echo "" >> docs/CLI_REFERENCE.md
        echo "\`\`\`" >> docs/CLI_REFERENCE.md
        ./target/release/st --help >> docs/CLI_REFERENCE.md
        echo "\`\`\`" >> docs/CLI_REFERENCE.md

        # Add output modes section
        echo "" >> docs/CLI_REFERENCE.md
        echo "## Output Modes" >> docs/CLI_REFERENCE.md
        echo "" >> docs/CLI_REFERENCE.md
        echo "| Mode | Description | AI-Optimized |" >> docs/CLI_REFERENCE.md
        echo "|------|-------------|--------------|" >> docs/CLI_REFERENCE.md
        echo "| classic | Traditional tree view | No |" >> docs/CLI_REFERENCE.md
        echo "| ai | Hex-compressed for LLMs | âœ… Yes |" >> docs/CLI_REFERENCE.md
        echo "| quantum | Binary delta compression | âœ… Yes |" >> docs/CLI_REFERENCE.md
        echo "| quantum-semantic | AST-aware compression | âœ… Yes |" >> docs/CLI_REFERENCE.md
        echo "| json | Structured JSON output | âœ… Yes |" >> docs/CLI_REFERENCE.md
        echo "| digest | SHA256 + stats only | âœ… Yes |" >> docs/CLI_REFERENCE.md
        echo "| context | Project context summary | âœ… Yes |" >> docs/CLI_REFERENCE.md
        echo "| marqant | Quantum markdown format | âœ… Yes |" >> docs/CLI_REFERENCE.md

    - name: Generate MCP tools documentation ðŸ”§
      run: |
        echo "# Smart Tree MCP Tools Reference" > docs/MCP_TOOLS.md
        echo "" >> docs/MCP_TOOLS.md
        echo "Auto-generated list of available MCP tools" >> docs/MCP_TOOLS.md
        echo "" >> docs/MCP_TOOLS.md
        echo "\`\`\`" >> docs/MCP_TOOLS.md
        ./target/release/st --mcp-tools >> docs/MCP_TOOLS.md 2>&1 || echo "MCP tools listing not available"
        echo "\`\`\`" >> docs/MCP_TOOLS.md
        echo "" >> docs/MCP_TOOLS.md
        echo "## Tool Categories" >> docs/MCP_TOOLS.md
        echo "" >> docs/MCP_TOOLS.md
        echo "- **Analysis**: overview, analyze, find, search" >> docs/MCP_TOOLS.md
        echo "- **Code Intelligence**: read, edit, context, relations" >> docs/MCP_TOOLS.md
        echo "- **Memory**: memory, history, context" >> docs/MCP_TOOLS.md
        echo "- **Utilities**: compare, feedback, hooks" >> docs/MCP_TOOLS.md

    - name: Check for documentation changes ðŸ”
      id: changes
      run: |
        if git diff --quiet docs/; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request ðŸ”„
      if: steps.changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "docs: Auto-update CLI and MCP documentation"
        title: "ðŸ“š Auto-update Documentation"
        body: |
          ## Automated Documentation Update

          This PR was automatically generated to update documentation based on code changes.

          ### Changes
          - Updated CLI reference from `--help` output
          - Updated MCP tools reference from `--mcp-tools` output

          ---
          ðŸ¤– Generated by Auto Documentation workflow
        branch: docs/auto-update
        delete-branch: true
        labels: documentation, automated

  update-readme-stats:
    name: Update README Statistics ðŸ“Š
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code ðŸ“¦
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install Rust ðŸ¦€
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo ðŸ“š
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-stats-${{ hashFiles('**/Cargo.lock') }}

    - name: Build and gather statistics ðŸ“ˆ
      run: |
        cargo build --release

        # Count various metrics
        TOTAL_LINES=$(find src -name "*.rs" -exec cat {} \; | wc -l)
        TOTAL_FILES=$(find src -name "*.rs" | wc -l)
        MCP_TOOLS=$(./target/release/st --mcp-tools 2>/dev/null | grep -c "^  " || echo "30+")
        OUTPUT_MODES=$(grep -c "OutputMode::" src/cli.rs 2>/dev/null || echo "20+")

        echo "TOTAL_LINES=$TOTAL_LINES" >> $GITHUB_ENV
        echo "TOTAL_FILES=$TOTAL_FILES" >> $GITHUB_ENV
        echo "MCP_TOOLS=$MCP_TOOLS" >> $GITHUB_ENV
        echo "OUTPUT_MODES=$OUTPUT_MODES" >> $GITHUB_ENV

    - name: Generate stats badge data ðŸ·ï¸
      run: |
        mkdir -p .github/badges

        # Create JSON for shields.io dynamic badges
        cat > .github/badges/stats.json << EOF
        {
          "schemaVersion": 1,
          "label": "Lines of Code",
          "message": "${{ env.TOTAL_LINES }}",
          "color": "blue"
        }
        EOF

        cat > .github/badges/mcp-tools.json << EOF
        {
          "schemaVersion": 1,
          "label": "MCP Tools",
          "message": "${{ env.MCP_TOOLS }}+",
          "color": "green"
        }
        EOF

        cat > .github/badges/output-modes.json << EOF
        {
          "schemaVersion": 1,
          "label": "Output Modes",
          "message": "${{ env.OUTPUT_MODES }}+",
          "color": "purple"
        }
        EOF

    - name: Upload badge data ðŸ“¤
      uses: actions/upload-artifact@v4
      with:
        name: badge-data
        path: .github/badges/

  generate-api-docs:
    name: Generate Rust API Docs ðŸ“œ
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code ðŸ“¦
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install Rust ðŸ¦€
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo ðŸ“š
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-api-${{ hashFiles('**/Cargo.lock') }}

    - name: Generate API documentation ðŸ“–
      run: |
        cargo doc --no-deps --document-private-items

        # Create index redirect
        echo '<meta http-equiv="refresh" content="0; url=st/index.html">' > target/doc/index.html

    - name: Upload API docs artifact ðŸ“¤
      uses: actions/upload-artifact@v4
      with:
        name: api-docs
        path: target/doc/
