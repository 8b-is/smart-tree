name: Rust CI ğŸ¦€

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Disable update checks during CI
  SMART_TREE_NO_UPDATE_CHECK: 1

permissions:
  contents: read

jobs:
  # Quick format and lint checks
  check:
    name: Format & Lint Check âœ¨
    runs-on: self-hosted
    
    steps:
    - name: Install cross-compilation linker
      run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu git-lfs && git lfs install
      
    - name: Checkout code ğŸ“¦
      uses: actions/checkout@v4
      with:
       x submodules: 'recursive'

    - name: Install Rust ğŸ¦€
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache cargo registry ğŸ“š
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-
    
  # Main build and test job
  build:
    name: Build & Test - ${{ matrix.name }} ğŸ”¨
    # needs: check  # Removed dependency on format/lint checks
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: self-hosted
            name: macOS
            rust: stable

    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.allow_failure == false }}
    
    steps:
    - name: Checkout code ğŸ“¦
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install Rust ğŸ¦€
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ matrix.rust }}
    
    - name: Cache cargo registry ğŸ“š
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-
    
    - name: Cache cargo index ğŸ“‘
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-index-

    - name: Cache cargo build ğŸ—ï¸
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}-${{ matrix.rust }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-cargo-build-target-
    
    - name: Build release ğŸš€
      run: cargo build --release --verbose
    
    - name: Run tests ğŸ§ª
      shell: bash
      run: |
        echo "=== Performance Monitor Start ===" 
        echo "Time: $(date)"
        echo "Memory: $(free -h 2>/dev/null || echo 'N/A')"
        echo "CPU: $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 'N/A')"
        echo "Disk: $(df -h . | tail -1)"
        echo "================================"
        
        # Run tests with timeout and performance tracking
        # Also show which tests are being executed
        # macOS doesn't have timeout command, use gtimeout if available
        if command -v timeout >/dev/null 2>&1; then
          TIMEOUT_CMD="timeout 300"
        elif command -v gtimeout >/dev/null 2>&1; then
          TIMEOUT_CMD="gtimeout 300"
        else
          TIMEOUT_CMD=""
        fi
        
        # TEMPORARILY: Only run lib tests, skip integration tests
        RUST_TEST_THREADS=1 $TIMEOUT_CMD cargo test --lib --verbose -- --nocapture --test-threads=1 || exit_code=$?
        
        echo "=== Performance Monitor End ===" 
        echo "Time: $(date)"
        echo "Exit code: ${exit_code:-0}"
        echo "=============================="
        
        exit ${exit_code:-0}
    
    - name: Run doc tests ğŸ“š
      run: cargo test --doc --verbose
    
    - name: Test examples ğŸ“
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        # Test that examples compile
        for example in examples/*.rs; do
          if [[ -f "$example" ]]; then
            example_name=$(basename "$example" .rs)
            echo "Testing example: $example_name"
            cargo build --example "$example_name" || true
          fi
        done
    
    # TEMPORARILY DISABLED: Binary execution hangs in CI
    - name: Test binary execution ğŸ¯
      shell: bash
      run: |
        # Test that the binary runs (CI env var already set by GitHub Actions)
        cargo run -- --version
        cargo run -- --help
       
        # Test basic functionality with limited depth to avoid hangs
        cargo run -- --mode classic --depth 1 .
        cargo run -- --mode hex --depth 1 .
        cargo run -- --mode ai --depth 1 .
    
    - name: Test MCP tools listing ğŸ› ï¸
      if: matrix.os != 'windows-latest'
      run: |
        cargo run -- --mcp-tools | head -20
    
  # Security audit
  security:
    name: Security Audit ğŸ”’
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code ğŸ“¦
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install Rust ğŸ¦€
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-audit ğŸ”
      run: cargo install cargo-audit
    
    - name: Run security audit ğŸ›¡ï¸
      run: cargo audit
      continue-on-error: true  # Don't fail the build on advisories
  
